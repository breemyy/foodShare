<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Profil - FoodShare</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div style="position: absolute; top: 20px; right: 20px; z-index: 1001;">
    <span id="settingsBtn" style="font-size: 1.8rem; cursor: pointer;">⚙️</span>
</div>

<div id="settingsDrawer" class="settings-drawer">
    <div class="drawer-header">
        <h2>Einstellungen</h2>
        <span onclick="closeSettings()" style="cursor:pointer; font-size: 1.5rem;">✕</span>
    </div>

    <div class="drawer-content">
        <div class="setting-row" onclick="changeUsername()">
            <span>Username ändern</span>
            <i class="fas fa-chevron-right"></i>
        </div>

        <div class="setting-row" onclick="requestPasswordReset()">
            <span>Passwort ändern</span>
            <i class="fas fa-chevron-right"></i>
        </div>

        <div class="setting-row">
            <span>Darkmode</span>
            <label class="switch">
                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="setting-row">
            <span>Benachrichtigungen</span>
            <label class="switch">
                <input type="checkbox" checked>
                <span class="slider round"></span>
            </label>
        </div>

        <button class="logout-btn-simple" onclick="handleSignOut()">Abmelden</button>
    </div>
</div>

<div id="drawerOverlay" class="drawer-overlay" onclick="closeSettings()"></div>

<div class="profile-container">
    
    <div class="profile-card">
        <div class="avatar-section">
            <div class="avatar-wrapper" onclick="document.getElementById('pfpInput').click()">
                <img id="profileDisplay" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKsAAACUCAMAAADbGilTAAAASFBMVEXp7e6vsrvt8fGrrrjEyMzp7eysr7fo7O+3usKusLvi5ujr7/Kvsrmytb3c4OLY3ODHytLV2N/Mz9S9wMjS1tnp7PO/wsbi5etrA41bAAADKklEQVR4nO2aC5KkIAxABeWjiCgyev+bLvb0TttOK860QHYr7wSvUgkJhKJAEARBEARBEARBEARBEARBEORfgXpyO5xCNMb2vXWmKVTBWG6dXahqrGx5eYOMtskttIMPIS0qzWtyo/YQXSkKMbKMqUGX5JlSO4iulPZ/Y/qEBVdmrPh4rUq4ze22hSnLX5kumdvnlttAzZ6qlzUFqKQV+mUCfKJBHQZ0NwM+s0DlFlwxy/bAlUiRW3DFcGRKSOtyCz5Q41EKEM7H3IYPhDyOK9G5DR802976LQngTDFdeVhafi4wUKZDasKuUI5YOgRd4YxbJ+IKxrUL1RbvwLjOAVV/DkDpXELIg8llQeZWXHE4usCat5UJpECX23CFmA4PghFKti4cXQs8BtL8WtBpX7acoDStT1ij91Rr3YAKq7/H7pcXpMJaYIUaXjcv3oF7zPAH18C/52zNDUBVxtQ8bp5eWj7Oub32EFauEoFzaRXAqN5RwknuU6GuScmlAXYAbKFUdM5W1nYCbkgfeEelYEd0DYNyFfxfoE/ktnnNosXE3Llq9EjPOFbWdY0QwDKCFsK4XuplW/TVvNp62RzpsXJGgKk0WgyVJPwmuelbbbu0BCLH4QNAQihh/J0gcDX0MyyfjCjy+S7bt8bK42vhajaQ1vexPNngh5UPbxp4cVnLEj8fZMpcMZDzpvdUIIap9FsZ2kxlOE+31LyaaeojjAbfhXaZ014VWeFebzTD+FIcVMrIUvfDRH3GJUwDaspfRvUe23SXMNrtPgacRKe7hh2vs84ENtXCi9rQM3aY0iVqCu9mgKfVSVype191Ka8UroHl60nKMUVgm9Dy9RS1TLD2DL23n4TrFM+H9q028EWZYt9RXaJKeJXA9ZJ0vbWD6NUl2mtygNQi+namu+LEWiijFxd17zfYu+sQe9ii1VWuvI/syuhFpeVdp8i1xcRbF4IndOzaaq5zjf65aLjqGFhGrbhJcPzJ8YeuLnJx9dflAIndZafrVPkUV7UJ/Wz5CXKO+rTVkfI6dNzXoqa6ksiHFr2SuKoIgiAIgiAIgiAIgiAIgiAIgpzkD93kIp5StnC6AAAAAElFTkSuQmCC" alt="Profilbild">
                <div class="overlay"><span>Ändern</span></div>
            </div>
            <input type="file" id="pfpInput" hidden accept="image/*" onchange="uploadPhoto(event)">
        </div>

        <h1 id="usernameDisplay">Lade...</h1>
        <p class="user-email" id="emailDisplay">E-Mail wird geladen...</p>

        <div class="stats-row">
            <div class="stat">
                <strong id="countSpenden">0</strong>
                <span>Spenden</span>
            </div>
            <div class="stat">
                <strong id="countRequests">0</strong>
                <span>Anfragen</span>
            </div>
        </div>

        <button class="logout-btn" onclick="handleSignOut()">Abmelden</button>
    </div>
</div>
<button class="back-circle-btn" onclick="window.location.href='index.html'" title="Zurück zur Startseite">
    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
    </svg>
</button>
    
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="script.js"></script>
<script>

    async function initProfile() {
        // 1. Session & Profil laden (dein bestehender Code)
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            window.location.href = 'index.html';
            return;
        }

        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();
        
        if (profile) {
            document.getElementById('usernameDisplay').innerText = profile.username;
            document.getElementById('emailDisplay').innerText = user.email;
            if (profile.avatar_url) {
                document.getElementById('profileDisplay').src = profile.avatar_url;
            }
        }

        const { count: postCount } = await supabaseClient
            .from('posts')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', user.id);
        
        document.getElementById('countSpenden').innerText = postCount || 0;

        // --- 2. HIER DIE BUTTON-LOGIK DIREKT AKTIVIEREN ---
        const settingsBtn = document.getElementById('settingsBtn');
        const drawer = document.getElementById('settingsDrawer');
        const overlay = document.getElementById('drawerOverlay');

        if (settingsBtn) {
            settingsBtn.onclick = function() {
                console.log("Zahnrad wurde gedrückt!");
                drawer.classList.add('open');
                overlay.style.display = 'block';
            };
        }
    }

    // Diese Funktion muss global verfügbar sein für das X und das Overlay
    function closeSettings() {
        document.getElementById('settingsDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').style.display = 'none';
    }

    initProfile();
</script>
</body>
</html>
